<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Content Calendar - Vanessa</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üì±</text></svg>">
</head>
<body>
    <!-- App Container -->
    <div id="app" class="app-container">
        
        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-view="today">Today</button>
            <button class="nav-tab" data-view="week">Week</button>
            <button class="nav-tab" data-view="filming">Filming</button>
            <button class="nav-tab" data-view="bank">Bank</button>
        </nav>

        <!-- TODAY VIEW -->
        <div id="today-view" class="view active">
            <div class="view-header">
                <h1 id="today-title">Loading...</h1>
                <p id="today-subtitle" class="text-muted"></p>
            </div>

            <!-- Today's Main Post -->
            <section id="today-post" class="card"></section>

            <!-- Tomorrow's Prep -->
            <section id="tomorrow-prep" class="card"></section>

            <!-- Week Progress -->
            <section class="card">
                <h3>This Week's Progress</h3>
                <div id="week-progress">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <p id="progress-text" class="text-muted"></p>
                </div>
                <div id="week-days" class="week-days-grid"></div>
            </section>
        </div>

        <!-- WEEK VIEW -->
        <div id="week-view" class="view">
            <div class="view-header">
                <button id="prev-week" class="week-nav">‚óÑ</button>
                <div>
                    <h1 id="week-title">Loading...</h1>
                    <p id="week-subtitle" class="text-muted"></p>
                </div>
                <button id="next-week" class="week-nav">‚ñ∫</button>
            </div>

            <div id="week-schedule" class="week-schedule"></div>

            <section class="card">
                <h3>Week Status</h3>
                <div id="week-status"></div>
            </section>
        </div>

        <!-- FILMING VIEW -->
        <div id="filming-view" class="view">
            <div class="view-header">
                <h1 id="filming-title">No Filming Scheduled</h1>
                <p id="filming-subtitle" class="text-muted"></p>
            </div>

            <div id="filming-content"></div>
        </div>

        <!-- CONTENT BANK VIEW -->
        <div id="bank-view" class="view">
            <div class="view-header">
                <h1>Content Bank</h1>
                <p class="text-muted">Inventory & Status</p>
            </div>

            <section class="card">
                <div id="bank-summary" class="bank-summary"></div>
            </section>

            <div id="bank-episodes"></div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="data.js"></script>
    <script>
        // === STATE MANAGEMENT ===
        let currentWeekIndex = 0;
        let currentView = 'today';

        // Load saved state
        function loadState() {
            const saved = localStorage.getItem('contentCalendar');
            return saved ? JSON.parse(saved) : { weeks: [] };
        }

        function saveState(state) {
            localStorage.setItem('contentCalendar', JSON.stringify(state));
        }

        // Initialize state from data.js
        let appState = loadState();
        if (appState.weeks.length === 0) {
            appState.weeks = CALENDAR_DATA.map(week => ({
                ...week,
                dailyTasks: Object.fromEntries(
                    Object.entries(week.dailyTasks).map(([date, day]) => [
                        date,
                        {
                            ...day,
                            tasks: day.tasks?.map(t => ({ ...t, done: false })) || [],
                            post: day.post ? { ...day.post, posted: false } : null
                        }
                    ])
                ),
                filmingDay: week.filmingDay ? {
                    ...week.filmingDay,
                    shoots: week.filmingDay.shoots.map(s => ({
                        ...s,
                        checklist: s.checklist?.map(item => ({ item, done: false })) || []
                    })),
                    postFilming: week.filmingDay.postFilming?.map(item => ({ item, done: false })) || []
                } : null
            }));
            saveState(appState);
        }

        // === UTILITY FUNCTIONS ===
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]} ${months[date.getMonth()]} ${date.getDate()}`;
        }

        function getTodayStr() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        function findCurrentWeek() {
            const today = getTodayStr();
            console.log('Looking for week containing:', today);
            
            for (let i = 0; i < appState.weeks.length; i++) {
                const week = appState.weeks[i];
                const dates = Object.keys(week.dailyTasks).sort();
                
                if (dates.length === 0) continue;
                
                console.log(`Week ${week.number}: ${dates[0]} to ${dates[dates.length-1]}`);
                
                if (today >= dates[0] && today <= dates[dates.length - 1]) {
                    console.log('Found current week:', week.number);
                    return i;
                }
            }
            
            console.log('No matching week, defaulting to week 0');
            return 0;
        }

        // === TODAY VIEW ===
        function renderTodayView() {
            const today = getTodayStr();
            const week = appState.weeks[currentWeekIndex];
            const todayData = week.dailyTasks[today];

            // Header
            document.getElementById('today-title').textContent = 
                `Week ${week.number} ¬∑ ${formatDate(today)}`;
            document.getElementById('today-subtitle').textContent = 
                week.theme || '';

            // Today's Post
            const postSection = document.getElementById('today-post');
            if (todayData?.post) {
                const post = todayData.post;
                const hoursUntil = calculateHoursUntil(today, post.time);
                
                postSection.innerHTML = `
                    <div class="post-header">
                        <h2>üìç Today's Post</h2>
                        <span class="badge ${post.posted ? 'badge-success' : 'badge-warning'}">
                            ${post.posted ? 'Posted ‚úì' : hoursUntil}
                        </span>
                    </div>
                    <div class="post-content">
                        <h3>${post.content}</h3>
                        <p class="text-muted">${post.length} ¬∑ ${post.time}</p>
                        <div class="post-status">
                            ${post.status === 'ready' ? '‚úÖ Ready to Post' : '‚è∫ ' + post.status}
                        </div>
                    </div>
                    <div class="post-actions">
                        <button onclick="viewCaption('${today}')" class="btn btn-secondary">View Caption</button>
                        <button onclick="markPosted('${today}')" class="btn ${post.posted ? 'btn-success' : 'btn-primary'}">
                            ${post.posted ? 'Posted ‚úì' : 'Mark Posted'}
                        </button>
                    </div>
                `;
            } else {
                postSection.innerHTML = `
                    <div class="post-header">
                        <h2>No Post Today</h2>
                    </div>
                    <p class="text-muted">Enjoy your ${todayData?.type === 'off' ? 'off day' : 'prep day'}!</p>
                `;
            }

            // Tasks for today
            if (todayData?.tasks && todayData.tasks.length > 0) {
                const tasksHtml = todayData.tasks.map((task, idx) => `
                    <label class="task-item">
                        <input type="checkbox" 
                               ${task.done ? 'checked' : ''} 
                               onchange="toggleTask('${today}', ${idx})">
                        <span class="${task.done ? 'task-done' : ''}">${task.task}</span>
                        ${task.time ? `<span class="task-time">${task.time}min</span>` : ''}
                    </label>
                `).join('');
                
                postSection.innerHTML += `
                    <div class="task-list">
                        <h4>Today's Tasks</h4>
                        ${tasksHtml}
                    </div>
                `;
            }

            // Tomorrow's Prep
            const dates = Object.keys(week.dailyTasks).sort();
            const todayIdx = dates.indexOf(today);
            const tomorrow = dates[todayIdx + 1];
            const tomorrowSection = document.getElementById('tomorrow-prep');
            
            if (tomorrow && week.dailyTasks[tomorrow]) {
                const tmrData = week.dailyTasks[tomorrow];
                tomorrowSection.innerHTML = `
                    <h3>üìã Tomorrow's Prep</h3>
                    <p class="text-muted">${formatDate(tomorrow)}</p>
                    ${tmrData.post ? `<p><strong>Post:</strong> ${tmrData.post.content}</p>` : ''}
                    ${tmrData.tasks ? `<p><strong>Tasks:</strong> ${tmrData.tasks.map(t => t.task).join(', ')}</p>` : ''}
                `;
            } else {
                tomorrowSection.innerHTML = `<p class="text-muted">End of week - enjoy your weekend!</p>`;
            }

            // Week Progress
            renderWeekProgress(week, today);
        }

        function calculateHoursUntil(dateStr, timeRange) {
            const now = new Date();
            const target = new Date(dateStr + 'T18:00:00'); // Assume 6pm
            const diff = target - now;
            
            if (diff < 0) return 'Post time passed';
            if (diff < 3600000) return `${Math.floor(diff/60000)} min`;
            return `Post in ${Math.floor(diff/3600000)}h`;
        }

        function renderWeekProgress(week, today) {
            const dates = Object.keys(week.dailyTasks).sort();
            const totalTasks = dates.reduce((sum, date) => {
                const day = week.dailyTasks[date];
                return sum + (day.tasks?.length || 0) + (day.post ? 1 : 0);
            }, 0);
            
            const completedTasks = dates.reduce((sum, date) => {
                const day = week.dailyTasks[date];
                const tasksDone = day.tasks?.filter(t => t.done).length || 0;
                const postDone = day.post?.posted ? 1 : 0;
                return sum + tasksDone + postDone;
            }, 0);

            const progress = totalTasks > 0 ? (completedTasks / totalTasks * 100) : 0;
            
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = 
                `${completedTasks}/${totalTasks} tasks complete`;

            // Day indicators
            const daysHtml = dates.map(date => {
                const day = week.dailyTasks[date];
                const isToday = date === today;
                const dayTasks = (day.tasks?.length || 0) + (day.post ? 1 : 0);
                const dayDone = (day.tasks?.filter(t => t.done).length || 0) + (day.post?.posted ? 1 : 0);
                const allDone = dayTasks > 0 && dayTasks === dayDone;
                
                return `
                    <div class="week-day ${isToday ? 'week-day-today' : ''} ${allDone ? 'week-day-done' : ''}">
                        ${formatDate(date).split(' ')[0]}
                    </div>
                `;
            }).join('');
            
            document.getElementById('week-days').innerHTML = daysHtml;
        }

        // === WEEK VIEW ===
        function renderWeekView() {
            const week = appState.weeks[currentWeekIndex];
            
            document.getElementById('week-title').textContent = 
                `Week ${week.number}: ${week.dates}`;
            document.getElementById('week-subtitle').textContent = week.theme || '';

            const schedule = document.getElementById('week-schedule');
            const dates = Object.keys(week.dailyTasks).sort();
            
            schedule.innerHTML = dates.map(date => {
                const day = week.dailyTasks[date];
                const isToday = date === getTodayStr();
                
                return `
                    <div class="day-card ${isToday ? 'day-card-today' : ''}">
                        <div class="day-header">
                            <h3>${formatDate(date)}</h3>
                            ${day.type ? `<span class="badge">${day.type}</span>` : ''}
                        </div>
                        
                        ${day.post ? `
                            <div class="day-post">
                                <strong>üì§ POST:</strong> ${day.post.content}
                                <br><span class="text-muted">${day.post.length} ¬∑ ${day.post.time}</span>
                                <br>
                                <button onclick="markPosted('${date}')" class="btn btn-sm ${day.post.posted ? 'btn-success' : 'btn-primary'}">
                                    ${day.post.posted ? 'Posted ‚úì' : 'Mark Posted'}
                                </button>
                            </div>
                        ` : ''}
                        
                        ${day.tasks && day.tasks.length > 0 ? `
                            <div class="day-tasks">
                                ${day.tasks.map((task, idx) => `
                                    <label class="task-item">
                                        <input type="checkbox" 
                                               ${task.done ? 'checked' : ''} 
                                               onchange="toggleTask('${date}', ${idx})">
                                        <span class="${task.done ? 'task-done' : ''}">${task.task}</span>
                                    </label>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${day.stories ? `
                            <details class="day-stories">
                                <summary>üì± Stories (${day.stories.length})</summary>
                                <ul>
                                    ${day.stories.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Week status
            const status = document.getElementById('week-status');
            status.innerHTML = `
                <p><strong>Time budget:</strong> ${week.totalTime || '6-7'} hours</p>
                <p><strong>Posts planned:</strong> ${dates.filter(d => week.dailyTasks[d].post).length}</p>
                ${week.filmingDay ? `<p><strong>Filming:</strong> ${formatDate(week.filmingDay.date)}</p>` : ''}
            `;
        }

        // === FILMING VIEW ===
        function renderFilmingView() {
            const week = appState.weeks[currentWeekIndex];
            const content = document.getElementById('filming-content');
            
            if (!week.filmingDay) {
                document.getElementById('filming-title').textContent = 'No Filming This Week';
                document.getElementById('filming-subtitle').textContent = 'Rest week';
                content.innerHTML = '<section class="card"><p class="text-muted">Enjoy your rest week!</p></section>';
                return;
            }
            const filming = week.filmingDay;
            const filmingDate = new Date(filming.date + 'T12:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            filmingDate.setHours(0, 0, 0, 0);
            
            const daysUntil = Math.ceil((filmingDate - today) / (1000 * 60 * 60 * 24));
            
            document.getElementById('filming-title').textContent = 
                `üé¨ Filming Day: ${formatDate(filming.date)}`;
            document.getElementById('filming-subtitle').textContent = 
                daysUntil > 0 ? `${daysUntil} days away` : 
                daysUntil === 0 ? 'Today!' : 
                `${Math.abs(daysUntil)} days ago`;
        
            content.innerHTML = `
                <section class="card">
                    <h3>‚è± Total Time: ${filming.duration} hours</h3>
                </section>
                ${filming.shoots.map((shoot, shootIdx) => `
                    <section class="card filming-shoot">
                        <h3>${shoot.type === 'series' ? `üìπ Episode ${shoot.episode}: ${shoot.title}` : `üí¨ ${shoot.type.toUpperCase()}`}</h3>
                        <p class="text-muted">${shoot.duration} minutes</p>
                        
                        ${shoot.concept ? `<p class="filming-concept"><em>${shoot.concept}</em></p>` : ''}
                        
                        ${shoot.checklist && shoot.checklist.length > 0 ? `
                            <h4>Setup Checklist</h4>
                            <div class="task-list">
                                ${shoot.checklist.map((checkItem, idx) => {
                                    const itemText = (typeof checkItem === 'object' && checkItem.item) ? checkItem.item : String(checkItem);
                                    const itemDone = (typeof checkItem === 'object') ? checkItem.done : false;
                                    
                                    return `
                                        <label class="task-item">
                                            <input type="checkbox" 
                                                   ${itemDone ? 'checked' : ''} 
                                                   onchange="toggleFilmingCheckbox(${shootIdx}, 'checklist', ${idx})">
                                            <span class="${itemDone ? 'task-done' : ''}">${itemText}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                        
                        ${shoot.derivatives && shoot.derivatives.length > 0 ? `
                            <details class="derivatives-section">
                                <summary class="derivatives-summary">üì¶ Derivatives to capture (${shoot.derivatives.length})</summary>
                                <ul class="derivatives-list">
                                    ${shoot.derivatives.map(d => `<li>${d}</li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}
                    </section>
                `).join('')}
        
                ${filming.postFilming && filming.postFilming.length > 0 ? `
                    <section class="card">
                        <h3>Post-Filming Tasks</h3>
                        <div class="task-list">
                            ${filming.postFilming.map((postItem, idx) => {
                                const itemText = (typeof postItem === 'object' && postItem.item) ? postItem.item : String(postItem);
                                const itemDone = (typeof postItem === 'object') ? postItem.done : false;
                                
                                return `
                                    <label class="task-item">
                                        <input type="checkbox" 
                                               ${itemDone ? 'checked' : ''} 
                                               onchange="toggleFilmingCheckbox(null, 'postFilming', ${idx})">
                                        <span class="${itemDone ? 'task-done' : ''}">${itemText}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </section>
                ` : ''}
                
                <section class="card filming-output">
                    <h3>üì¶ What This Produces</h3>
                    <ul>
                        ${filming.shoots.map(shoot => {
                            if (shoot.type === 'series') {
                                return `<li>1 main episode (editor delivers in 48hrs)</li>
                                        <li>${shoot.derivatives ? shoot.derivatives.length : 6} potential derivatives</li>`;
                            } else {
                                return `<li>1 ${shoot.type} video (ready to post)</li>`;
                            }
                        }).join('')}
                    </ul>
                </section>
            `;
        }
        // === CONTENT BANK VIEW ===
        function renderBankView() {
            // Count content by status
            let ready = 0, needsEdit = 0, withEditor = 0;
            
            appState.weeks.forEach(week => {
                Object.values(week.dailyTasks).forEach(day => {
                    if (day.post) {
                        if (day.post.posted) ready++;
                        else if (day.post.status === 'ready') ready++;
                        else if (day.post.status === 'with editor') withEditor++;
                        else needsEdit++;
                    }
                });
            });

            document.getElementById('bank-summary').innerHTML = `
                <div class="bank-stat">
                    <span class="bank-count" style="color: var(--success);">${ready}</span>
                    <span class="text-muted">Ready/Posted</span>
                </div>
                <div class="bank-stat">
                    <span class="bank-count" style="color: var(--warning);">${needsEdit}</span>
                    <span class="text-muted">Needs Work</span>
                </div>
                <div class="bank-stat">
                    <span class="bank-count" style="color: var(--info);">${withEditor}</span>
                    <span class="text-muted">With Editor</span>
                </div>
            `;

            // Show episodes by week
            const episodes = document.getElementById('bank-episodes');
            const episodeData = [];
            
            appState.weeks.forEach(week => {
                Object.entries(week.dailyTasks).forEach(([date, day]) => {
                    if (day.post && day.post.content.includes('Episode')) {
                        episodeData.push({ date, post: day.post, week: week.number });
                    }
                });
            });

            episodes.innerHTML = episodeData.map(ep => `
                <section class="card">
                    <h3>${ep.post.content}</h3>
                    <p class="text-muted">Week ${ep.week} ¬∑ ${formatDate(ep.date)}</p>
                    <div class="badge ${ep.post.posted ? 'badge-success' : 'badge-warning'}">
                        ${ep.post.posted ? 'Posted' : ep.post.status}
                    </div>
                </section>
            `).join('');
        }

        // === INTERACTION HANDLERS ===
        function toggleTask(date, taskIdx) {
            const week = appState.weeks[currentWeekIndex];
            week.dailyTasks[date].tasks[taskIdx].done = !week.dailyTasks[date].tasks[taskIdx].done;
            saveState(appState);
            renderCurrentView();
        }

        function markPosted(date) {
            const week = appState.weeks[currentWeekIndex];
            if (week.dailyTasks[date]?.post) {
                week.dailyTasks[date].post.posted = !week.dailyTasks[date].post.posted;
                saveState(appState);
                renderCurrentView();
            }
        }

        function viewCaption(date) {
            const week = appState.weeks[currentWeekIndex];
            const post = week.dailyTasks[date]?.post;
            if (post) {
                alert(`Caption for ${post.content}:\n\n${post.caption}\n\n${post.hashtags?.join(' ') || ''}`);
            }
        }

        function toggleFilmingCheckbox(shootIdx, type, idx) {
            const week = appState.weeks[currentWeekIndex];
            if (!week.filmingDay) return;
            
            if (type === 'postFilming') {
                const item = week.filmingDay.postFilming[idx];
                if (typeof item === 'object' && item.item) {
                    week.filmingDay.postFilming[idx].done = !week.filmingDay.postFilming[idx].done;
                } else {
                    week.filmingDay.postFilming[idx] = {
                        item: typeof item === 'string' ? item : String(item),
                        done: true
                    };
                }
            } else if (shootIdx !== null && type === 'checklist') {
                const item = week.filmingDay.shoots[shootIdx].checklist[idx];
                if (typeof item === 'object' && item.item) {
                    week.filmingDay.shoots[shootIdx].checklist[idx].done = !week.filmingDay.shoots[shootIdx].checklist[idx].done;
                } else {
                    week.filmingDay.shoots[shootIdx].checklist[idx] = {
                        item: typeof item === 'string' ? item : String(item),
                        done: true
                    };
                }
            }
            
            saveState(appState);
            renderFilmingView();
        }

        // === NAVIGATION ===
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`${viewName}-view`).classList.add('active');
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            currentView = viewName;
            renderCurrentView();
        }

        function changeWeek(delta) {
            currentWeekIndex = Math.max(0, Math.min(appState.weeks.length - 1, currentWeekIndex + delta));
            renderCurrentView();
        }

        function renderCurrentView() {
            switch(currentView) {
                case 'today': renderTodayView(); break;
                case 'week': renderWeekView(); break;
                case 'filming': renderFilmingView(); break;
                case 'bank': renderBankView(); break;
            }
        }

        // === EVENT LISTENERS ===
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => switchView(e.target.dataset.view));
        });

        document.getElementById('prev-week').addEventListener('click', () => changeWeek(-1));
        document.getElementById('next-week').addEventListener('click', () => changeWeek(1));

        // === INITIALIZATION ===
        currentWeekIndex = findCurrentWeek();
        renderTodayView();

        // === SERVICE WORKER (PWA) ===
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
